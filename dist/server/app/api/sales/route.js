(()=>{var e={};e.id=82,e.ids=[82],e.modules={3524:e=>{"use strict";e.exports=require("@prisma/client")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9348:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},412:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3258:(e,t,a)=>{"use strict";a.r(t),a.d(t,{patchFetch:()=>f,routeModule:()=>y,serverHooks:()=>w,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>x});var r={};a.r(r),a.d(r,{GET:()=>l,OPTIONS:()=>p,PATCH:()=>d,POST:()=>m});var s=a(8797),o=a(42),n=a(8492),u=a(3524),i=a(9540);let c=new u.PrismaClient;async function l(e,t){try{let e=await c.sales.findMany({include:{customers:{select:{name:!0}}}}),t=0,a=e.map(e=>(t+=e.salesPrice,{id:e.id,productName:e.productName,category:e.category,subCategory:e.subCategory,quantity:e.quantity,perPacket:e.perPacket,totalpacket:e.totalpacket,salesPrice:e.salesPrice,customer_id:e.customer_id,customerName:e.customers?.name||null,paymentStatus:e.paymentStatus,note:e.note,created_at:e.created_at,updated_at:e.updated_at}));return i.NextResponse.json({status:"ok",data:a,totalSalesPrice:t})}catch(e){return console.log(e.message),i.NextResponse.json({status:500,error:"Failed to get all Sales!"})}}async function d(e,t){let{searchParams:a}=new URL(e.url),r=Number(a.get("userId"));try{let e=await c.sales.findMany({where:{customer_id:r},orderBy:{created_at:"desc"}});return i.NextResponse.json({status:"ok",data:e})}catch(e){return console.log(e.message),i.NextResponse.json({status:500,error:"Failed to get all categories!"})}}async function p(e,t){let{searchParams:a}=new URL(e.url),r=Number(a.get("userId"));try{let e=(await c.sales.aggregate({where:{customer_id:r,paymentStatus:"due"},_sum:{salesPrice:!0}}))._sum.salesPrice||0;return i.NextResponse.json({status:"ok",data:e})}catch(e){return console.log(e.message),i.NextResponse.json({status:500,error:"Failed to get all categories!"})}}async function m(e,t){try{let{selectedProduct:t,category:a,subCategory:r,perPacket:s,totalpacket:o,quantity:n,totalPrice:u,customer_id:l,paymentStatus:d,note:p}=await e.json(),m=JSON.parse(t),y={id:Number(m?.id),name:m?.name},g=await c.products.findFirst({where:{id:Number(m?.id)}});if(!g)return console.error("Product not found"),i.NextResponse.json({status:404,error:"Product not found"});let x=await c.products.count({where:y});if(g.quantity<x)return console.error("Insufficient product quantity"),i.NextResponse.json({error:"Insufficient product quantity"},{status:400});let w=await c.$transaction(async e=>{let t={productName:m?.name,category:a,subCategory:r,quantity:n?parseFloat(n):null,perPacket:s?parseFloat(s):null,salesPrice:u?parseFloat(u):null,totalpacket:o?parseFloat(o):null,customer_id:parseInt(l),paymentStatus:d,note:p||g.note},i=await e.sales.create({data:t});return await e.products.update({where:{id:g.id},data:{quantity:g.quantity-n}}),"due"===d&&await e.dueList.create({data:{name:m?.name,productCategory:a,subCategory:r||null,customer_id:parseInt(l),amount:u?parseFloat(u):0,note:p||g.note}}),i});return i.NextResponse.json({status:"ok",data:w},{status:201})}catch(e){return console.error("Error creating sale:",e.message),i.NextResponse.json({error:"Failed to create sale"},{status:500})}}let y=new s.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/sales/route",pathname:"/api/sales",filename:"route",bundlePath:"app/api/sales/route"},resolvedPagePath:"H:\\Apps-key\\milon-store-sharif-backend\\src\\app\\api\\sales\\route.js",nextConfigOutput:"",userland:r}),{workAsyncStorage:g,workUnitAsyncStorage:x,serverHooks:w}=y;function f(){return(0,n.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:x})}},8031:()=>{},5303:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[492,661],()=>a(3258));module.exports=r})();